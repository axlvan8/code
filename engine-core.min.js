import{executeBlock}from'./engine-advanced.min.js';

////////////////////////////////////////
// GLOBALS
////////////////////////////////////////
let dragged = null;
let currentDrop = null;
////////////////////////////////////////
// EXECUTE BLOCK
////////////////////////////////////////


////////////////////////////////////////
// SPRITE SYSTEM
////////////////////////////////////////
class Sprite {
    constructor(name) {
        this.name = name;
        this.x = 240;
        this.y = 180;
        this.dir = 0;
        this.size = 1;
        this.color = "#0077cc";
        this.costume = null;
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.dir * Math.PI/180);
        ctx.fillStyle = this.color;
        ctx.fillRect(-15*this.size, -15*this.size, 30*this.size, 30*this.size);
        ctx.restore();
    }
}

let sprites = [new Sprite("Sprite1")];

////////////////////////////////////////
// CANVAS STAGE
////////////////////////////////////////
const canvas = document.getElementById("stage");
const ctx = canvas.getContext("2d");

function renderStage() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let s of sprites) {
        s.draw(ctx);
    }
    requestAnimationFrame(renderStage);
}

renderStage();

////////////////////////////////////////
// DRAG & DROP BLOCKS
////////////////////////////////////////
document.addEventListener("dragstart", (e) => {
    const block = e.target.closest(".block");
    if (!block) return;
    dragged = block.cloneNode(true);
    dragged.classList.add("clone");
    dragged.style.opacity = "0.5";
});

document.addEventListener("dragover", (e) => {
    e.preventDefault();
    const target = e.target.closest(".droptarget");
    if (target) currentDrop = target;
});

document.addEventListener("drop", (e) => {
    e.preventDefault();
    if (!dragged || !currentDrop) return;
    const copy = dragged.cloneNode(true);
    copy.classList.remove("clone");
    copy.removeAttribute("id");
    copy.setAttribute("draggable", "true");
    copy.querySelectorAll("input").forEach(i => i.disabled = false);
    currentDrop.appendChild(copy);
    dragged = null;
    currentDrop = null;
});

////////////////////////////////////////
// SERIALIZER
////////////////////////////////////////
function serializeBlock(block) {
    const type = block.dataset.type;
    let obj = { type };
    const inputs = block.querySelectorAll("input");
    if (inputs.length) obj.inputs = [...inputs].map(i=>i.value);
    const substacks = block.querySelectorAll(":scope > .substack");
    if (substacks.length) obj.substacks = [...substacks].map(stack => serializeStack(stack));
    return obj;
}

function serializeStack(container) {
    return [...container.children].filter(c => c.classList.contains("block")).map(serializeBlock);
}

function saveScript() {
    const root = document.getElementById("script-area");
    localStorage.setItem("scratchScript", JSON.stringify(serializeStack(root)));
    alert("Saved!");
}

function loadScript() {
    const json = localStorage.getItem("scratchScript");
    if (!json) return;
    const data = JSON.parse(json);
    const root = document.getElementById("script-area");
    root.innerHTML = "";
    rebuildStack(root, data);
}

function rebuildBlock(obj) {
    let tpl = document.querySelector(`.block[data-type="${obj.type}"]`);
    let block = tpl.cloneNode(true);
    block.removeAttribute("id");
    if (obj.inputs) {
        const inputs = block.querySelectorAll("input");
        obj.inputs.forEach((v,i)=>inputs[i].value = v);
    }
    if (obj.substacks) {
        const subs = block.querySelectorAll(":scope > .substack");
        obj.substacks.forEach((st,i)=>rebuildStack(subs[i], st));
    }
    return block;
}

function rebuildStack(container, arr) {
    arr.forEach(obj=>container.appendChild(rebuildBlock(obj)));
}

////////////////////////////////////////
// BUTTONS
////////////////////////////////////////
document.getElementById("clear").onclick = () => document.getElementById("script-area").innerHTML = "";
document.getElementById("save").onclick = saveScript;
loadScript();

////////////////////////////////////////
// VM EXECUTION
////////////////////////////////////////
function runScript() {
    const rootData = serializeStack(document.getElementById("script-area"));
    executeStack(rootData);
}

function executeStack(stack) {
    for (let block of stack) executeBlock(block);
}



document.getElementById("run").onclick = runScript;
